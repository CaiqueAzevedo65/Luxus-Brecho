name: ğŸ“± Luxus-Brecho Mobile CI/CD

on:
  push:
    branches: [main, dev, mobile]
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'Tipo de build'
        options:
          - preview
          - production
        default: 'preview'
        
permissions:
  contents: write
  packages: write

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd mobile
          npm install

      - name: ğŸ”§ Instalar EAS CLI globalmente
        run: |
          npm install -g eas-cli
          eas --version

      - name: ğŸ” Verificar autenticaÃ§Ã£o Expo
        run: |
          echo "Verificando token Expo..."
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ ERRO: EXPO_TOKEN nÃ£o configurado!"
            exit 1
          fi
          echo "âœ… EXPO_TOKEN configurado"
          eas whoami

      - name: ğŸ” Debug configuraÃ§Ã£o
        run: |
          echo "ğŸ“‹ InformaÃ§Ãµes do build:"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          cd mobile
          echo "VersÃ£o do app:"
          node -p "require('./app.json').expo.version"

      - name: ğŸ—ï¸ Build APK
        id: build
        run: |
          cd mobile
          BUILD_TYPE="${{ github.event.inputs.build_type || 'preview' }}"
          echo "ğŸ“± Iniciando build com profile: $BUILD_TYPE"
          
          eas build --platform android --profile $BUILD_TYPE --local --non-interactive --output ../app.apk
          
          if [ $? -eq 0 ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Build concluÃ­do com sucesso!"
          else
            echo "build_status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Build falhou!"
            exit 1
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“ Obter informaÃ§Ãµes da versÃ£o
        id: version
        if: always()
        run: |
          cd mobile
          VERSION=$(node -p "require('./app.json').expo.version")
          BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Upload APK como artifact
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_status == 'success'
        with:
          name: luxus-brecho-v${{ steps.version.outputs.version }}-build-${{ github.run_number }}
          path: app.apk
          retention-days: 30

      - name: ğŸš€ Criar GitHub Release
        uses: softprops/action-gh-release@v1
        if: steps.build.outputs.build_status == 'success'
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: ğŸ›ï¸ Luxus-Brecho v${{ steps.version.outputs.version }} Build #${{ github.run_number }}
          draft: false
          prerelease: false
          files: app.apk
          body: |
            ## ğŸ›ï¸ Luxus-Brecho Mobile App
            
            **ğŸ“¦ VersÃ£o:** ${{ steps.version.outputs.version }}
            **ğŸ”¢ Build:** #${{ github.run_number }}
            **ğŸ“… Data:** ${{ steps.version.outputs.build_date }}
            **ğŸŒ¿ Branch:** ${{ github.ref_name }}
            **ğŸ‘¤ Autor:** ${{ github.actor }}
            
            ---
            
            ### ğŸ“ AlteraÃ§Ãµes:
            ${{ github.event.head_commit.message }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“§ Enviar email - Sucesso
        uses: dawidd6/action-send-mail@v3
        if: steps.build.outputs.build_status == 'success'
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Build #${{ github.run_number }} - Luxus-Brecho"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ›ï¸ Build ConcluÃ­do!</h2>
            <p><strong>VersÃ£o:</strong> ${{ steps.version.outputs.version }}</p>
            <p><strong>Build:</strong> #${{ github.run_number }}</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}-${{ github.run_number }}">ğŸ“¥ Download APK</a></p>

      - name: ğŸ“§ Enviar email - Falha
        uses: dawidd6/action-send-mail@v3
        if: steps.build.outputs.build_status == 'failure'
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Build #${{ github.run_number }} Falhou"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>âŒ Build Falhou</h2>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Ver Logs</a></p>

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f app.apk 2>/dev/null || true
