name: ğŸ“± Luxus-Brecho Mobile CI/CD

on:
  push:
    branches: [main, dev, mobile]
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'Tipo de build'
        options:
          - preview
          - production
        default: 'preview'

jobs:
  test:
    name: ğŸ§ª Testes e Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd mobile
          npm ci

      - name: ğŸ” TypeScript check
        run: |
          cd mobile
          npx tsc --noEmit
        continue-on-error: true

      - name: ğŸ§¹ ESLint
        run: |
          cd mobile
          npm run lint
        continue-on-error: true

  build:
    name: ğŸ“± Build Android APK
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd mobile
          npm ci

      - name: ğŸ”§ Setup Expo e EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ” Debug configuraÃ§Ã£o
        run: |
          echo "ğŸ“‹ InformaÃ§Ãµes do build:"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          cd mobile
          echo "VersÃ£o do app:"
          node -p "require('./app.json').expo.version"

      - name: ğŸ—ï¸ Build APK
        id: build
        run: |
          cd mobile
          BUILD_TYPE="${{ github.event.inputs.build_type || 'preview' }}"
          echo "ğŸ“± Building com profile: $BUILD_TYPE"
          
          eas build --platform android --profile $BUILD_TYPE --local --non-interactive --output ../app.apk
          
          if [ $? -eq 0 ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Build concluÃ­do com sucesso!"
          else
            echo "build_status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Build falhou!"
            exit 1
          fi
        continue-on-error: true

      - name: ğŸ“ Obter informaÃ§Ãµes da versÃ£o
        id: version
        if: always()
        run: |
          cd mobile
          VERSION=$(node -p "require('./app.json').expo.version")
          BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Upload APK como artifact
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_status == 'success'
        with:
          name: luxus-brecho-v${{ steps.version.outputs.version }}-build-${{ github.run_number }}
          path: app.apk
          retention-days: 30

      - name: ğŸš€ Criar GitHub Release
        uses: softprops/action-gh-release@v1
        if: steps.build.outputs.build_status == 'success'
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: ğŸ›ï¸ Luxus-Brecho v${{ steps.version.outputs.version }} Build #${{ github.run_number }}
          draft: false
          prerelease: false
          files: app.apk
          body: |
            ## ğŸ›ï¸ Luxus-Brecho Mobile App
            
            **ğŸ“¦ VersÃ£o:** ${{ steps.version.outputs.version }}
            **ğŸ”¢ Build:** #${{ github.run_number }}
            **ğŸ“… Data:** ${{ steps.version.outputs.build_date }}
            **ğŸŒ¿ Branch:** ${{ github.ref_name }}
            **ğŸ‘¤ Autor:** ${{ github.actor }}
            
            ---
            
            ### ğŸ“ AlteraÃ§Ãµes neste commit:
            ${{ github.event.head_commit.message }}
            
            ---
            
            ### ğŸ“± Como instalar:
            1. Baixe o arquivo APK abaixo
            2. Habilite "Instalar apps de fontes desconhecidas" no Android
            3. Instale o APK
            4. Aproveite o Luxus-Brecho! ğŸ›’
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Debug secrets de email
        if: always()
        run: |
          echo "ğŸ” Verificando secrets:"
          if [ -z "${{ secrets.EMAIL_FROM }}" ]; then
            echo "âŒ EMAIL_FROM: VAZIO"
          else
            echo "âœ… EMAIL_FROM: configurado"
          fi
          if [ -z "${{ secrets.EMAIL_TO }}" ]; then
            echo "âŒ EMAIL_TO: VAZIO"
          else
            echo "âœ… EMAIL_TO: configurado"
          fi

      - name: ğŸ“§ Enviar email - Build Sucesso
        uses: dawidd6/action-send-mail@v3
        if: steps.build.outputs.build_status == 'success'
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Luxus-Brecho Mobile - Build #${{ github.run_number }} Sucesso"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ›ï¸ Build Luxus-Brecho ConcluÃ­do com Sucesso!</h2>
            
            <table style="border-collapse: collapse; width: 100%; margin: 20px 0;">
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ“¦ VersÃ£o</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.version.outputs.version }}</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ”¢ Build</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
              </tr>
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ“… Data</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.version.outputs.build_date }}</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸŒ¿ Branch</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
              </tr>
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ‘¤ Autor</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.actor }}</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ’¬ Commit</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.event.head_commit.message }}</td>
              </tr>
            </table>
            
            <hr style="margin: 20px 0;">
            
            <h3>ğŸ“¥ Downloads e Links:</h3>
            <ul>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}-${{ github.run_number }}" style="color: #0366d6; text-decoration: none;">ğŸ“± Download APK</a></li>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #0366d6; text-decoration: none;">ğŸ“Š Ver Logs do Build</a></li>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts" style="color: #0366d6; text-decoration: none;">ğŸ“¦ Artifacts</a></li>
            </ul>
            
            <p style="color: #28a745; font-weight: bold;">âœ… Build realizado com sucesso!</p>

      - name: ğŸ“§ Enviar email - Build Falhou
        uses: dawidd6/action-send-mail@v3
        if: steps.build.outputs.build_status == 'failure'
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Luxus-Brecho Mobile - Build #${{ github.run_number }} Falhou"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ›ï¸ Build Luxus-Brecho Falhou</h2>
            
            <table style="border-collapse: collapse; width: 100%; margin: 20px 0;">
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ”¢ Build</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ“… Data</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.version.outputs.build_date }}</td>
              </tr>
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸŒ¿ Branch</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ‘¤ Autor</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.actor }}</td>
              </tr>
              <tr style="background-color: #f0f0f0;">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>ğŸ’¬ Commit</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;">${{ github.event.head_commit.message }}</td>
              </tr>
            </table>
            
            <hr style="margin: 20px 0;">
            
            <h3>ğŸ” Investigar o erro:</h3>
            <ul>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #0366d6; text-decoration: none;">ğŸ“Š Ver Logs Completos</a></li>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/commits/${{ github.ref_name }}" style="color: #0366d6; text-decoration: none;">ğŸ“ Ver Commits Recentes</a></li>
            </ul>
            
            <p style="color: #d73a49; font-weight: bold;">âŒ O build falhou. Verifique os logs para mais detalhes.</p>

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
          rm -f app.apk 2>/dev/null || true
          echo "âœ… Cleanup concluÃ­do!"
